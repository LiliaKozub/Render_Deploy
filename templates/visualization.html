<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–í—ñ–∑—É–∞–ª—ñ–∑–∞—Ü—ñ—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∏ –±–∞–∑–∏ –¥–∞–Ω–∏—Ö</title>
    <svg id="svg-connections" style="position:absolute; top:0; left:0; width:100%; height:100%; z-index:-1;"></svg>

<style>
        body {
            font-family: 'Courier New', Courier, monospace;
            background-color: #2E2E2E;
            color: #E0E0E0;
            margin: 0;
            padding: 0;
            overflow: hidden;
        }

        h1 {
            text-align: center;
            font-size: 2em;
            margin: 20px 0;
            color: #E0E0E0;
        }

        #tables-container {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 50px;
            position: relative;
            margin: 0 auto;
            padding: 20px;
        }

        .table-container {
            width: auto;
            max-width: 300px;
            position: absolute;
            font-size: 12px;
            border: 2px solid #444;
            background-color: #333;
            margin: 10px;
            padding: 10px;
            border-radius: 8px;
            box-shadow: 0px 4px 10px rgba(0, 0, 0, 0.5);
            cursor: move;
            transition: transform 0.2s ease, box-shadow 0.3s ease;
        }

        .table-container:hover {
            transform: scale(1.05);
            box-shadow: 0px 6px 20px rgba(0, 0, 0, 0.7);
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 6px;
            font-size: 13px;
            border: 1px solid #555;
            text-align: left;
            color: #E0E0E0;
        }

        th {
            background-color: #444;
            font-weight: bold;
        }

        h2.table-title {
            font-size: 14px;
            margin: 5px 0;
            text-align: center;
            color: #E0E0E0;
        }

        .icons {
            display: inline-block;
            width: 3em;
            text-align: center;
        }

        .tooltip {
            position: relative;
            display: inline-block;
            cursor: help;
        }

        .tooltip .tooltiptext {
            visibility: hidden;
            width: 140px;
            background-color: #333;
            color: #fff;
            text-align: center;
            border-radius: 6px;
            padding: 5px;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            margin-left: -70px;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .tooltip:hover .tooltiptext {
            visibility: visible;
            opacity: 1;
        }

        .line-connection {
            position: absolute;
            height: 2px;
            background-color: #FF6F61;
            transform: scaleX(0);
            transform-origin: left;
            animation: drawLine 0.5s ease-out forwards;
        }

        .arrow {
            width: 0;
            height: 0;
            border: 10px solid transparent;
            border-left: 10px solid #FF6F61;
            position: absolute;
        }

        svg {
            pointer-events: none;
        }

        path {
            stroke: #FF6F61;
            stroke-width: 2;
            fill: none;
        }

        .back-button {
            background-color: #444;
            color: #fff;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            cursor: pointer;
            position: absolute;
            top: 20px;
            left: 20px;
            z-index: 1;
            transition: background-color 0.3s ease;
        }

        .back-button:hover {
            background-color: #666;
        }

    </style>
</head>
<body>
    <button class="back-button" onclick="window.history.back()">–ü–æ–≤–µ—Ä–Ω—É—Ç–∏—Å—è –¥–æ –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏ –∑–∞–ø–∏—Ç—ñ–≤</button>

    <h1>–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –±–∞–∑–∏ –¥–∞–Ω–∏—Ö</h1>

    <div id="tables-container">
    {% for table_name, table_data in db_structure.items() %}
    <div class="table-container" id="table-{{ table_name }}">
        <h2 class="table-title">{{ table_name }}</h2>
        <table>
            <thead>
                <tr>
                    <th>–Ü–º'—è —Å—Ç–æ–≤–ø—Ü—è</th>
                    <th>–¢–∏–ø –¥–∞–Ω–∏—Ö</th>
                </tr>
            </thead>
            <tbody>
                {% for column in table_data.columns %}
                <tr id="column-{{ table_name }}-{{ column.name }}">
                    <td>
                        <span class="icons">
                            {% if column.pk %}
                            <span class="tooltip">
                                üîë
                                <span class="tooltiptext">–ü–µ—Ä–≤–∏–Ω–Ω–∏–π –∫–ª—é—á</span>
                            </span>
                            {% endif %}
                            {% if column.not_null %}
                            <span class="tooltip">
                                ‚úîÔ∏è
                                <span class="tooltiptext">NOT NULL</span>
                            </span>
                            {% endif %}
                            {% if column.uniqueKey %}
                            <span class="tooltip">
                                üåü
                                <span class="tooltiptext">–£–Ω—ñ–∫–∞–ª—å–Ω–∏–π –∫–ª—é—á</span>
                            </span>
                            {% endif %}
                            {% for fk in table_data.foreign_keys %}
                            {% if fk.from_column == column.name %}
                            <span class="tooltip">
                                üîó
                                <span class="tooltiptext">
                                    –ó–æ–≤–Ω—ñ—à–Ω—ñ–π –∫–ª—é—á ‚Üí {{ fk.to_table }}.{{ fk.to_column }}
                                </span>
                            </span>
                            {% endif %}
                            {% endfor %}
                        </span>
                        <span>{{ column.name }}</span>
                    </td>
                    <td>{{ column.type }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% endfor %}
</div>

    <script>
function drawCurvedLine(sourceElement, targetElement) {
        const svg = document.getElementById("svg-connections");

        const sourceRect = sourceElement.getBoundingClientRect();
        const targetRect = targetElement.getBoundingClientRect();

        const startX = sourceRect.right + window.scrollX; // –ü—Ä–∞–≤–∞ —Å—Ç–æ—Ä–æ–Ω–∞ –≤–∏—Ö—ñ–¥–Ω–æ–≥–æ –µ–ª–µ–º–µ–Ω—Ç–∞
        const startY = sourceRect.top + sourceRect.height / 2 + window.scrollY;
        const endX = targetRect.left + window.scrollX; // –õ—ñ–≤–∞ —Å—Ç–æ—Ä–æ–Ω–∞ —Ü—ñ–ª—å–æ–≤–æ–≥–æ –µ–ª–µ–º–µ–Ω—Ç–∞
        const endY = targetRect.top + targetRect.height / 2 + window.scrollY;

        // –ö—Ä–∏–≤–∞ –ë–µ–∑—å—î
        const controlX1 = startX + (endX - startX) / 2;
        const controlY1 = startY;
        const controlX2 = controlX1;
        const controlY2 = endY;

        const path = document.createElementNS("http://www.w3.org/2000/svg", "path");
        path.setAttribute(
            "d",
            `M ${startX},${startY} C ${controlX1},${controlY1} ${controlX2},${controlY2} ${endX},${endY}`
        );
        path.setAttribute("stroke", "#FF6F61");
        path.setAttribute("stroke-width", "2");
        path.setAttribute("fill", "none");
        path.setAttribute("marker-end", "url(#arrowhead)");

        svg.appendChild(path);
    }

    function addArrowMarker() {
        const svg = document.getElementById("svg-connections");
        let defs = svg.querySelector("defs");

        if (!defs) {
            defs = document.createElementNS("http://www.w3.org/2000/svg", "defs");
            svg.appendChild(defs);
        }

        // –í–∏–¥–∞–ª—è—î–º–æ —Å—Ç–∞—Ä–∏–π –º–∞—Ä–∫–µ—Ä, —è–∫—â–æ –≤—ñ–Ω —ñ—Å–Ω—É—î
        const existingMarker = document.getElementById("arrowhead");
        if (existingMarker) existingMarker.remove();

        // –°—Ç–≤–æ—Ä—é—î–º–æ –Ω–æ–≤–∏–π –º–∞—Ä–∫–µ—Ä
        const marker = document.createElementNS("http://www.w3.org/2000/svg", "marker");
        marker.setAttribute("id", "arrowhead");
        marker.setAttribute("viewBox", "0 0 10 10");
        marker.setAttribute("refX", "10"); // –ü–æ–∑–∏—Ü—ñ—è —Å—Ç—Ä—ñ–ª–∫–∏
        marker.setAttribute("refY", "5");
        marker.setAttribute("markerWidth", "6");
        marker.setAttribute("markerHeight", "6");
        marker.setAttribute("orient", "auto");

        const arrowPath = document.createElementNS("http://www.w3.org/2000/svg", "path");
        arrowPath.setAttribute("d", "M 0 0 L 10 5 L 0 10 Z"); // –°—Ç—Ä—ñ–ª–∫–∞ —É –≤–∏–≥–ª—è–¥—ñ —Ç—Ä–∏–∫—É—Ç–Ω–∏–∫–∞
        arrowPath.setAttribute("fill", "#FF6F61"); // –ö–æ–ª—ñ—Ä —Å—Ç—Ä—ñ–ª–∫–∏

        marker.appendChild(arrowPath);
        defs.appendChild(marker);
    }

    function drawAllLines() {
        const svg = document.getElementById("svg-connections");
        svg.innerHTML = ""; // –û—á–∏—â—É—î–º–æ SVG –ø–µ—Ä–µ–¥ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è–º

        const tables = document.querySelectorAll(".table-container");
        tables.forEach((table) => {
            const tableId = table.id.split("-")[1];
            const columns = table.querySelectorAll("tr");

            columns.forEach((column) => {
                const columnId = column.id.split("-")[2];

                const foreignKey = getForeignKeyForColumn(tableId, columnId);
                if (foreignKey) {
                    const [refTable, refColumn] = foreignKey.split(".");
                    const refColumnElement = document.getElementById(`column-${refTable}-${refColumn}`);
                    if (refColumnElement) {
                        drawCurvedLine(column, refColumnElement);
                    } else {
                        console.error(`Target element for ${refTable}.${refColumn} not found.`);
                    }
                }
            });
        });
    }

    function getForeignKeyForColumn(tableName, columnName) {
        const foreignKeys = {{ db_structure | tojson }};
        const keys = foreignKeys[tableName]?.foreign_keys || [];
        for (let fk of keys) {
            if (fk.from_column === columnName) {
                return `${fk.to_table}.${fk.to_column}`;
            }
        }
        return null;
    }

    window.onload = function () {
        addArrowMarker(); // –î–æ–¥–∞—î–º–æ —Å—Ç—Ä—ñ–ª–∫–∏
        const tables = document.querySelectorAll(".table-container");
        tables.forEach((table) => makeDraggable(table));
        drawAllLines(); // –ú–∞–ª—é—î–º–æ –≤—Å—ñ –ª—ñ–Ω—ñ—ó
    };

    let isDragging = false;
    let activeTable = null;
    let offsetX, offsetY;

    function makeDraggable(table) {
        table.addEventListener("mousedown", (e) => {
            isDragging = true;
            activeTable = table;
            offsetX = e.clientX - table.offsetLeft;
            offsetY = e.clientY - table.offsetTop;
        });
    }

    document.addEventListener("mousemove", (e) => {
        if (isDragging && activeTable) {
            activeTable.style.left = `${e.clientX - offsetX}px`;
            activeTable.style.top = `${e.clientY - offsetY}px`;
            drawAllLines();
        }
    });

    document.addEventListener("mouseup", () => {
        isDragging = false;
        activeTable = null;
    });
    </script>
</body>
</html>
